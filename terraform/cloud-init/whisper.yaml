#cloud-config
# Whisper GPU Inference Server (Docker-based)
# Requires: debian-12-nvidia template (NVIDIA drivers pre-installed)
# Sets up: Docker, NVIDIA Container Toolkit, Whisper API container, Watchtower for auto-updates

hostname: whisper
manage_etc_hosts: true

package_update: true
package_upgrade: false

packages:
  - ca-certificates
  - curl
  - gnupg
  - git
  - wget
  - htop
  - unzip
  - nginx
  - certbot
  - python3-certbot-dns-cloudflare

users:
  - default
  - name: whisper
    groups: [sudo, video, render, docker]
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL

write_files:
  # Cloudflare credentials for Let's Encrypt
  - path: /etc/letsencrypt/cloudflare.ini
    permissions: "0600"
    content: |
      dns_cloudflare_api_token = ${cloudflare_api_token}

  # Nginx configuration
  - path: /etc/nginx/sites-available/whisper
    permissions: "0644"
    content: |
      server {
          listen 80;
          server_name ${domain};

          location / {
              return 301 https://$host$request_uri;
          }
      }

      server {
          listen 443 ssl;
          server_name ${domain};

          ssl_certificate /etc/letsencrypt/live/${domain}/fullchain.pem;
          ssl_certificate_key /etc/letsencrypt/live/${domain}/privkey.pem;
          ssl_protocols TLSv1.2 TLSv1.3;
          ssl_ciphers HIGH:!aNULL:!MD5;

          client_max_body_size 100M;

          location / {
              proxy_pass http://127.0.0.1:8000;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;

              # Extended timeouts for queued requests and long audio processing
              proxy_read_timeout 600s;
              proxy_connect_timeout 60s;
              proxy_send_timeout 600s;

              # Disable buffering for better streaming behavior
              proxy_buffering off;
              proxy_request_buffering off;
          }
      }

  # Cert renewal hook
  - path: /etc/letsencrypt/renewal-hooks/deploy/reload-nginx.sh
    permissions: "0755"
    content: |
      #!/bin/bash
      systemctl reload nginx

  # Docker Compose configuration for Whisper API + Watchtower
  - path: /opt/whisper/docker-compose.yaml
    permissions: "0644"
    content: |
      services:
        whisper-api:
          image: ghcr.io/${github_owner}/whisper-api:latest
          container_name: whisper-api
          restart: unless-stopped
          ports:
            - "127.0.0.1:8000:8000"
          volumes:
            - whisper-cache:/app/.cache
          environment:
            - WHISPER_MODEL=turbo
            - WHISPER_DEVICE=cuda
            - XDG_CACHE_HOME=/app/.cache
          deploy:
            resources:
              reservations:
                devices:
                  - driver: nvidia
                    count: 1
                    capabilities: [gpu]
          logging:
            driver: json-file
            options:
              max-size: "10m"
              max-file: "3"

        watchtower:
          image: nickfedor/watchtower
          container_name: watchtower
          restart: unless-stopped
          volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - /home/whisper/.docker/config.json:/config.json:ro
          environment:
            - WATCHTOWER_CLEANUP=true
            - WATCHTOWER_POLL_INTERVAL=300
            - WATCHTOWER_INCLUDE_STOPPED=false
            - DOCKER_CONFIG=/
          command: whisper-api
      volumes:                   # <-- ADD THIS at the end
        whisper-cache:

  # Main setup script - runs once on first boot
  - path: /opt/whisper/setup.sh
    permissions: "0755"
    content: |
      #!/bin/bash
      # Whisper API Docker Setup Script
      # NVIDIA drivers are pre-installed in the template

      LOG_FILE="/var/log/whisper-setup.log"
      exec > >(tee -a "$LOG_FILE") 2>&1

      echo ""
      echo "=========================================="
      echo "Whisper Docker Setup - $(date)"
      echo "=========================================="

      SETUP_COMPLETE="/opt/whisper/.setup_complete"

      # If setup is complete, exit
      if [ -f "$SETUP_COMPLETE" ]; then
          echo "Setup already complete."
          exit 0
      fi

      # Verify GPU is available
      echo ""
      echo "=== Checking GPU ==="
      if ! nvidia-smi; then
          echo "ERROR: NVIDIA GPU not detected!"
          echo "Make sure you're using the debian-12-nvidia template"
          echo "and GPU passthrough is configured correctly."
          exit 1
      fi

      echo ""
      echo "GPU detected:"
      nvidia-smi --query-gpu=name,memory.total,driver_version --format=csv

      # Install NVIDIA Container Toolkit
      echo ""
      echo "=== Installing NVIDIA Container Toolkit ==="
      if ! command -v nvidia-ctk &> /dev/null; then
          curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
          curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \
              sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
              tee /etc/apt/sources.list.d/nvidia-container-toolkit.list
          apt-get update
          apt-get install -y nvidia-container-toolkit
          nvidia-ctk runtime configure --runtime=docker
          systemctl restart docker
          echo "NVIDIA Container Toolkit installed"
      else
          echo "NVIDIA Container Toolkit already installed"
      fi

      # Setup GHCR authentication
      echo ""
      echo "=== Configuring GHCR authentication ==="
      mkdir -p /home/whisper/.docker
      echo '{"auths":{"ghcr.io":{"auth":"${ghcr_auth}"}}}' > /home/whisper/.docker/config.json
      chown -R whisper:whisper /home/whisper/.docker
      chmod 600 /home/whisper/.docker/config.json
      echo "GHCR authentication configured"

      # Ensure ownership
      chown -R whisper:whisper /opt/whisper

      # Pull and start containers
      echo ""
      echo "=== Starting Whisper API containers ==="
      cd /opt/whisper
      sudo -u whisper docker compose pull
      sudo -u whisper docker compose up -d

      # Wait for API to be ready
      echo ""
      echo "=== Waiting for API to be ready ==="
      for i in {1..60}; do
          if curl -s http://localhost:8000/health | grep -q "healthy"; then
              break
          fi
          echo "Waiting... ($i/60)"
          sleep 5
      done

      # Verify setup
      if curl -s http://localhost:8000/health | grep -q "healthy"; then
          touch "$SETUP_COMPLETE"
          chown whisper:whisper "$SETUP_COMPLETE"

          echo ""
          echo "=========================================="
          echo "SETUP COMPLETE!"
          echo "=========================================="
          echo ""
          echo "Whisper API: https://${domain}"
          echo "Health check: curl https://${domain}/health"
          echo "Queue status: curl https://${domain}/queue/status"
          echo ""

          # Disable setup service
          systemctl disable whisper-setup.service
      else
          echo "ERROR: Whisper API failed to start"
          docker compose logs whisper-api
          exit 1
      fi

  # Systemd service for setup (runs once on first boot)
  - path: /etc/systemd/system/whisper-setup.service
    permissions: "0644"
    content: |
      [Unit]
      Description=Whisper API Docker Setup
      After=network-online.target docker.service
      Wants=network-online.target
      Requires=docker.service

      [Service]
      Type=oneshot
      ExecStart=/opt/whisper/setup.sh
      RemainAfterExit=yes
      StandardOutput=journal+console
      StandardError=journal+console

      [Install]
      WantedBy=multi-user.target

  # Promtail configuration for shipping logs to Loki (updated for Docker)
  - path: /etc/promtail/config.yaml
    permissions: "0644"
    content: |
      server:
        http_listen_port: 9080
        grpc_listen_port: 0

      positions:
        filename: /var/lib/promtail/positions.yaml

      clients:
        - url: http://192.168.20.11:31100/loki/api/v1/push

      scrape_configs:
        # Scrape Docker container logs
        - job_name: docker
          docker_sd_configs:
            - host: unix:///var/run/docker.sock
              refresh_interval: 5s
          relabel_configs:
            - source_labels: ['__meta_docker_container_name']
              regex: '/(.+)'
              target_label: container
            - source_labels: ['__meta_docker_container_name']
              regex: '/(whisper-api|watchtower)'
              action: keep
            - action: labelmap
              regex: __meta_docker_container_label_(.+)
          pipeline_stages:
            - json:
                expressions:
                  log: log
                  stream: stream
                  time: time
            - output:
                source: log

        - job_name: system
          journal:
            max_age: 12h
            labels:
              job: system
              host: whisper-gpu
          relabel_configs:
            - source_labels: ['__journal__systemd_unit']
              regex: '(sshd|systemd-.*|nvidia-.*|docker.*)\.service'
              action: keep
            - source_labels: ['__journal__systemd_unit']
              target_label: unit
            - source_labels: ['__journal_priority_keyword']
              target_label: level

  # Systemd service for Promtail
  - path: /etc/systemd/system/promtail.service
    permissions: "0644"
    content: |
      [Unit]
      Description=Promtail Log Collector
      After=network-online.target docker.service
      Wants=network-online.target

      [Service]
      Type=simple
      User=root
      ExecStart=/usr/local/bin/promtail -config.file=/etc/promtail/config.yaml
      Restart=always
      RestartSec=10

      [Install]
      WantedBy=multi-user.target

  # Promtail installation script
  - path: /opt/whisper/install-promtail.sh
    permissions: "0755"
    content: |
      #!/bin/bash
      set -e

      PROMTAIL_VERSION="3.6.3"
      ARCH="amd64"

      echo "Installing Promtail ${PROMTAIL_VERSION}..."

      cd /tmp
      wget -q "https://github.com/grafana/loki/releases/download/v${PROMTAIL_VERSION}/promtail-linux-${ARCH}.zip"
      unzip -o "promtail-linux-${ARCH}.zip"
      chmod +x "promtail-linux-${ARCH}"
      mv "promtail-linux-${ARCH}" /usr/local/bin/promtail
      rm -f "promtail-linux-${ARCH}.zip"

      mkdir -p /var/lib/promtail
      mkdir -p /etc/promtail

      systemctl daemon-reload
      systemctl enable promtail
      systemctl start promtail

      echo "Promtail installed and started!"

runcmd:
  - mkdir -p /opt/whisper
  - chown -R whisper:whisper /opt/whisper
  - echo "Whisper cloud-init started at $(date)" >> /var/log/whisper-setup.log

  # Install Docker CE from official repository
  - install -m 0755 -d /etc/apt/keyrings
  - curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc
  - chmod a+r /etc/apt/keyrings/docker.asc
  - |
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian $(. /etc/os-release && echo $VERSION_CODENAME) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
  - usermod -aG docker whisper
  - systemctl enable docker
  - systemctl start docker

  # Create letsencrypt directories
  - mkdir -p /etc/letsencrypt/renewal-hooks/deploy

  # Get Let's Encrypt certificate
  - |
    certbot certonly \
      --dns-cloudflare \
      --dns-cloudflare-credentials /etc/letsencrypt/cloudflare.ini \
      -d ${domain} \
      --non-interactive \
      --agree-tos \
      -m ${letsencrypt_email}

  # Configure nginx
  - rm -f /etc/nginx/sites-enabled/default
  - ln -sf /etc/nginx/sites-available/whisper /etc/nginx/sites-enabled/whisper
  - systemctl enable nginx
  - systemctl start nginx

  # Install Promtail for log shipping
  - /opt/whisper/install-promtail.sh

  # Enable and start setup service
  - systemctl daemon-reload
  - systemctl enable whisper-setup.service
  - systemctl start whisper-setup.service
