{
  "version": 4,
  "terraform_version": "1.14.3",
  "serial": 182,
  "lineage": "e05b919b-edf6-d388-fe7d-2f0d5cdf29f8",
  "outputs": {
    "ai_vm_ip": {
      "value": "192.168.20.30",
      "type": "string"
    },
    "db_vm_ip": {
      "value": "192.168.20.21",
      "type": "string"
    },
    "infisical_url": {
      "value": "https://192.168.20.22:8443",
      "type": "string"
    },
    "infisical_vm_ip": {
      "value": "192.168.20.22",
      "type": "string"
    },
    "k3s_vm_ip": {
      "value": "192.168.20.11",
      "type": "string"
    },
    "whisper_api_url": {
      "value": "http://192.168.20.30:8000",
      "type": "string"
    }
  },
  "resources": [
    {
      "mode": "managed",
      "type": "proxmox_virtual_environment_file",
      "name": "ai_cloud_init",
      "provider": "provider[\"registry.terraform.io/bpg/proxmox\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "content_type": "snippets",
            "datastore_id": "local",
            "file_mode": null,
            "file_modification_date": null,
            "file_name": "ai-cloud-init.yaml",
            "file_size": null,
            "file_tag": null,
            "id": "local:snippets/ai-cloud-init.yaml",
            "node_name": "server",
            "overwrite": true,
            "source_file": [],
            "source_raw": [
              {
                "data": "#cloud-config\n# AI Services GPU Inference Server (Docker-based)\n# Services: Whisper (speech-to-text), Ollama (LLM inference)\n# Requires: debian-12-nvidia template (NVIDIA drivers pre-installed)\n# Sets up: Docker, NVIDIA Container Toolkit, Whisper API, Ollama, Watchtower\n\nhostname: ai-gpu\nmanage_etc_hosts: true\n\npackage_update: true\npackage_upgrade: false\n\npackages:\n  - ca-certificates\n  - curl\n  - gnupg\n  - git\n  - wget\n  - htop\n  - unzip\n  - nginx\n  - certbot\n  - python3-certbot-dns-cloudflare\n\nusers:\n  - default\n  - name: ai\n    groups: [sudo, video, render, docker]\n    shell: /bin/bash\n    sudo: ALL=(ALL) NOPASSWD:ALL\n\nwrite_files:\n  # Cloudflare credentials for Let's Encrypt\n  - path: /etc/letsencrypt/cloudflare.ini\n    permissions: \"0600\"\n    content: |\n      dns_cloudflare_api_token = Og7UTeuQqILzmS6sYHXDb4TYTSISnQDJC1xkPS99\n\n  # Nginx configuration - routes /transcribe to Whisper, /generate and /api to Ollama\n  - path: /etc/nginx/sites-available/ai\n    permissions: \"0644\"\n    content: |\n      server {\n          listen 80;\n          server_name ai.internal.prakash.com.br;\n\n          location / {\n              return 301 https://$host$request_uri;\n          }\n      }\n\n      server {\n          listen 443 ssl;\n          server_name ai.internal.prakash.com.br;\n\n          ssl_certificate /etc/letsencrypt/live/ai.internal.prakash.com.br/fullchain.pem;\n          ssl_certificate_key /etc/letsencrypt/live/ai.internal.prakash.com.br/privkey.pem;\n          ssl_protocols TLSv1.2 TLSv1.3;\n          ssl_ciphers HIGH:!aNULL:!MD5;\n\n          client_max_body_size 100M;\n\n          # Health check endpoint\n          location = /health {\n              proxy_pass http://127.0.0.1:8000/health;\n              proxy_set_header Host $host;\n              proxy_set_header X-Real-IP $remote_addr;\n          }\n\n          # Whisper transcription endpoints\n          location /transcribe {\n              proxy_pass http://127.0.0.1:8000/transcribe;\n              proxy_set_header Host $host;\n              proxy_set_header X-Real-IP $remote_addr;\n              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n              proxy_set_header X-Forwarded-Proto $scheme;\n\n              # Extended timeouts for audio processing\n              proxy_read_timeout 600s;\n              proxy_connect_timeout 60s;\n              proxy_send_timeout 600s;\n              proxy_buffering off;\n              proxy_request_buffering off;\n          }\n\n          # Ollama generate endpoint (for custom prompts)\n          location /generate {\n              proxy_pass http://127.0.0.1:11434/api/generate;\n              proxy_set_header Host $host;\n              proxy_set_header X-Real-IP $remote_addr;\n              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n              proxy_set_header X-Forwarded-Proto $scheme;\n\n              # Extended timeouts for LLM processing\n              proxy_read_timeout 300s;\n              proxy_connect_timeout 60s;\n              proxy_send_timeout 300s;\n          }\n\n          # Ollama chat endpoint (OpenAI-compatible)\n          location /v1/chat/completions {\n              proxy_pass http://127.0.0.1:11434/v1/chat/completions;\n              proxy_set_header Host $host;\n              proxy_set_header X-Real-IP $remote_addr;\n              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n              proxy_set_header X-Forwarded-Proto $scheme;\n              proxy_read_timeout 300s;\n          }\n\n          # Ollama API (full access)\n          location /api/ {\n              proxy_pass http://127.0.0.1:11434/api/;\n              proxy_set_header Host $host;\n              proxy_set_header X-Real-IP $remote_addr;\n              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n              proxy_set_header X-Forwarded-Proto $scheme;\n              proxy_read_timeout 300s;\n          }\n\n          # Queue status (whisper)\n          location /queue {\n              proxy_pass http://127.0.0.1:8000/queue;\n              proxy_set_header Host $host;\n              proxy_set_header X-Real-IP $remote_addr;\n          }\n\n          # Swagger docs for whisper\n          location /docs {\n              proxy_pass http://127.0.0.1:8000/docs;\n              proxy_set_header Host $host;\n              proxy_set_header X-Real-IP $remote_addr;\n          }\n\n          location /openapi.json {\n              proxy_pass http://127.0.0.1:8000/openapi.json;\n              proxy_set_header Host $host;\n          }\n\n          # Root shows service info\n          location = / {\n              default_type application/json;\n              return 200 '{\"service\":\"AI Services\",\"endpoints\":{\"/transcribe\":\"Speech-to-text (Whisper)\",\"/generate\":\"Text generation (Ollama)\",\"/v1/chat/completions\":\"OpenAI-compatible chat\",\"/api/\":\"Full Ollama API\",\"/health\":\"Health check\",\"/docs\":\"Whisper API docs\"}}';\n          }\n      }\n\n  # Cert renewal hook\n  - path: /etc/letsencrypt/renewal-hooks/deploy/reload-nginx.sh\n    permissions: \"0755\"\n    content: |\n      #!/bin/bash\n      systemctl reload nginx\n\n\n  # Docker Compose configuration\n  - path: /opt/ai/docker-compose.yaml\n    permissions: \"0644\"\n    content: |\n      services:\n        whisper-api:\n          image: ghcr.io/prem-prakash/whisper-api:latest\n          container_name: whisper-api\n          restart: unless-stopped\n          ports:\n            - \"127.0.0.1:8000:8000\"\n          volumes:\n            - whisper-cache:/app/.cache\n          environment:\n            - WHISPER_MODEL=turbo\n            - WHISPER_DEVICE=cuda\n            - XDG_CACHE_HOME=/app/.cache\n          deploy:\n            resources:\n              reservations:\n                devices:\n                  - driver: nvidia\n                    count: 1\n                    capabilities: [gpu]\n          logging:\n            driver: json-file\n            options:\n              max-size: \"10m\"\n              max-file: \"3\"\n\n        ollama:\n          image: ollama/ollama:latest\n          container_name: ollama\n          restart: unless-stopped\n          ports:\n            - \"127.0.0.1:11434:11434\"\n          volumes:\n            - ollama-data:/root/.ollama\n          environment:\n            - OLLAMA_KEEP_ALIVE=5m\n          deploy:\n            resources:\n              reservations:\n                devices:\n                  - driver: nvidia\n                    count: 1\n                    capabilities: [gpu]\n          logging:\n            driver: json-file\n            options:\n              max-size: \"10m\"\n              max-file: \"3\"\n\n        watchtower:\n          image: nickfedor/watchtower\n          container_name: watchtower\n          restart: unless-stopped\n          volumes:\n            - /var/run/docker.sock:/var/run/docker.sock\n            - /home/ai/.docker/config.json:/config.json:ro\n          environment:\n            - WATCHTOWER_CLEANUP=true\n            - WATCHTOWER_POLL_INTERVAL=300\n            - WATCHTOWER_INCLUDE_STOPPED=false\n            - DOCKER_CONFIG=/\n          command: whisper-api ollama\n\n      volumes:\n        whisper-cache:\n        ollama-data:\n\n  # Main setup script - runs once on first boot\n  - path: /opt/ai/setup.sh\n    permissions: \"0755\"\n    content: |\n      #!/bin/bash\n      # AI Services Docker Setup Script\n      # NVIDIA drivers are pre-installed in the template\n\n      LOG_FILE=\"/var/log/ai-setup.log\"\n      exec \u003e \u003e(tee -a \"$LOG_FILE\") 2\u003e\u00261\n\n      echo \"\"\n      echo \"==========================================\"\n      echo \"AI Services Setup - $(date)\"\n      echo \"==========================================\"\n\n      SETUP_COMPLETE=\"/opt/ai/.setup_complete\"\n\n      # If setup is complete, exit\n      if [ -f \"$SETUP_COMPLETE\" ]; then\n          echo \"Setup already complete.\"\n          exit 0\n      fi\n\n      # Verify GPU is available\n      echo \"\"\n      echo \"=== Checking GPU ===\"\n      if ! nvidia-smi; then\n          echo \"ERROR: NVIDIA GPU not detected!\"\n          echo \"Make sure you're using the debian-12-nvidia template\"\n          echo \"and GPU passthrough is configured correctly.\"\n          exit 1\n      fi\n\n      echo \"\"\n      echo \"GPU detected:\"\n      nvidia-smi --query-gpu=name,memory.total,driver_version --format=csv\n\n      # Install NVIDIA Container Toolkit\n      echo \"\"\n      echo \"=== Installing NVIDIA Container Toolkit ===\"\n      if ! command -v nvidia-ctk \u0026\u003e /dev/null; then\n          curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg\n          curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \\\n              sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \\\n              tee /etc/apt/sources.list.d/nvidia-container-toolkit.list\n          apt-get update\n          apt-get install -y nvidia-container-toolkit\n          nvidia-ctk runtime configure --runtime=docker\n          systemctl restart docker\n          echo \"NVIDIA Container Toolkit installed\"\n      else\n          echo \"NVIDIA Container Toolkit already installed\"\n      fi\n\n      # Setup GHCR authentication\n      echo \"\"\n      echo \"=== Configuring GHCR authentication ===\"\n      mkdir -p /home/ai/.docker\n      echo '{\"auths\":{\"ghcr.io\":{\"auth\":\"cHJlbS1wcmFrYXNoOmdocF9Kc0xyNGdCSlFTdWxZRWxZenR1ejZidEFEbnhKdmMyNkY5VXk=\"}}}' \u003e /home/ai/.docker/config.json\n      chown -R ai:ai /home/ai/.docker\n      chmod 600 /home/ai/.docker/config.json\n      echo \"GHCR authentication configured\"\n\n      # Ensure ownership\n      chown -R ai:ai /opt/ai\n\n      # Pull and start containers\n      echo \"\"\n      echo \"=== Starting AI Services containers ===\"\n      cd /opt/ai\n      sudo -u ai docker compose pull\n      sudo -u ai docker compose up -d\n\n      # Wait for Ollama to be ready and pull the model\n      echo \"\"\n      echo \"=== Pulling Ollama model (qwen2.5:3b) ===\"\n      for i in {1..30}; do\n          if curl -s http://localhost:11434/api/tags \u003e /dev/null 2\u003e\u00261; then\n              break\n          fi\n          echo \"Waiting for Ollama... ($i/30)\"\n          sleep 5\n      done\n\n      # Pull the translation model\n      echo \"Pulling qwen2.5:3b...\"\n      curl -X POST http://localhost:11434/api/pull -d '{\"name\": \"qwen2.5:3b\"}' --no-buffer\n\n      # Wait for Whisper API to be ready\n      echo \"\"\n      echo \"=== Waiting for Whisper API to be ready ===\"\n      for i in {1..60}; do\n          if curl -s http://localhost:8000/health | grep -q \"healthy\"; then\n              break\n          fi\n          echo \"Waiting... ($i/60)\"\n          sleep 5\n      done\n\n      # Verify setup\n      WHISPER_OK=$(curl -s http://localhost:8000/health | grep -q \"healthy\" \u0026\u0026 echo \"yes\" || echo \"no\")\n      OLLAMA_OK=$(curl -s http://localhost:11434/api/tags | grep -q \"qwen2.5:3b\" \u0026\u0026 echo \"yes\" || echo \"no\")\n\n      if [ \"$WHISPER_OK\" = \"yes\" ] \u0026\u0026 [ \"$OLLAMA_OK\" = \"yes\" ]; then\n          touch \"$SETUP_COMPLETE\"\n          chown ai:ai \"$SETUP_COMPLETE\"\n\n          echo \"\"\n          echo \"==========================================\"\n          echo \"SETUP COMPLETE!\"\n          echo \"==========================================\"\n          echo \"\"\n          echo \"AI Services: https://ai.internal.prakash.com.br\"\n          echo \"\"\n          echo \"Endpoints:\"\n          echo \"  - Transcription: POST https://ai.internal.prakash.com.br/transcribe\"\n          echo \"  - Generate:      POST https://ai.internal.prakash.com.br/generate\"\n          echo \"  - Chat:          POST https://ai.internal.prakash.com.br/v1/chat/completions\"\n          echo \"  - Health:        GET  https://ai.internal.prakash.com.br/health\"\n          echo \"\"\n          echo \"Status:\"\n          echo \"  - Whisper API: $WHISPER_OK\"\n          echo \"  - Ollama:      $OLLAMA_OK\"\n          echo \"\"\n\n          # Disable setup service\n          systemctl disable ai-setup.service\n      else\n          echo \"ERROR: Some services failed to start\"\n          echo \"  - Whisper API: $WHISPER_OK\"\n          echo \"  - Ollama: $OLLAMA_OK\"\n          docker compose logs\n          exit 1\n      fi\n\n  # Systemd service for setup (runs once on first boot)\n  - path: /etc/systemd/system/ai-setup.service\n    permissions: \"0644\"\n    content: |\n      [Unit]\n      Description=AI Services Docker Setup\n      After=network-online.target docker.service\n      Wants=network-online.target\n      Requires=docker.service\n\n      [Service]\n      Type=oneshot\n      ExecStart=/opt/ai/setup.sh\n      RemainAfterExit=yes\n      StandardOutput=journal+console\n      StandardError=journal+console\n\n      [Install]\n      WantedBy=multi-user.target\n\n  # Promtail configuration for shipping logs to Loki\n  - path: /etc/promtail/config.yaml\n    permissions: \"0644\"\n    content: |\n      server:\n        http_listen_port: 9080\n        grpc_listen_port: 0\n\n      positions:\n        filename: /var/lib/promtail/positions.yaml\n\n      clients:\n        - url: http://192.168.20.11:31100/loki/api/v1/push\n\n      scrape_configs:\n        # Scrape Docker container logs\n        - job_name: docker\n          docker_sd_configs:\n            - host: unix:///var/run/docker.sock\n              refresh_interval: 5s\n          relabel_configs:\n            - target_label: job\n              replacement: docker\n            - source_labels: ['__meta_docker_container_name']\n              regex: '/(.+)'\n              target_label: container\n            - source_labels: ['__meta_docker_container_name']\n              regex: '/(whisper-api|ollama|watchtower)'\n              action: keep\n            - source_labels: ['__meta_docker_container_label_com_docker_compose_service']\n              target_label: compose_service\n            - source_labels: ['__meta_docker_container_label_com_docker_compose_project']\n              target_label: compose_project\n            - source_labels: ['__meta_docker_container_label_com_docker_compose_service']\n              target_label: service_name\n            - source_labels: ['__meta_docker_container_id']\n              target_label: __path__\n              replacement: /var/lib/docker/containers/$1/$1-json.log\n            - action: labelkeep\n              regex: '^(job|container|compose_service|compose_project|service_name)$'\n          pipeline_stages:\n            - json:\n                expressions:\n                  log: log\n                  stream: stream\n                  time: time\n            - output:\n                source: log\n\n        - job_name: system\n          journal:\n            max_age: 12h\n            labels:\n              job: system\n              host: ai-gpu\n          relabel_configs:\n            - source_labels: ['__journal__systemd_unit']\n              regex: '(sshd|systemd-.*|nvidia-.*|docker.*)\\.service'\n              action: keep\n            - source_labels: ['__journal__systemd_unit']\n              target_label: unit\n            - source_labels: ['__journal_priority_keyword']\n              target_label: level\n\n  # Systemd service for Promtail\n  - path: /etc/systemd/system/promtail.service\n    permissions: \"0644\"\n    content: |\n      [Unit]\n      Description=Promtail Log Collector\n      After=network-online.target docker.service\n      Wants=network-online.target\n\n      [Service]\n      Type=simple\n      User=root\n      ExecStart=/usr/local/bin/promtail -config.file=/etc/promtail/config.yaml\n      Restart=always\n      RestartSec=10\n\n      [Install]\n      WantedBy=multi-user.target\n\n  # Promtail installation script\n  - path: /opt/ai/install-promtail.sh\n    permissions: \"0755\"\n    content: |\n      #!/bin/bash\n      set -e\n\n      PROMTAIL_VERSION=\"3.6.3\"\n      ARCH=\"amd64\"\n\n      echo \"Installing Promtail ${PROMTAIL_VERSION}...\"\n\n      cd /tmp\n      wget -q \"https://github.com/grafana/loki/releases/download/v${PROMTAIL_VERSION}/promtail-linux-${ARCH}.zip\"\n      unzip -o \"promtail-linux-${ARCH}.zip\"\n      chmod +x \"promtail-linux-${ARCH}\"\n      mv \"promtail-linux-${ARCH}\" /usr/local/bin/promtail\n      rm -f \"promtail-linux-${ARCH}.zip\"\n\n      mkdir -p /var/lib/promtail\n      mkdir -p /etc/promtail\n\n      systemctl daemon-reload\n      systemctl enable promtail\n      systemctl start promtail\n\n      echo \"Promtail installed and started!\"\n\nruncmd:\n  - mkdir -p /opt/ai\n  - chown -R ai:ai /opt/ai\n  - echo \"AI services cloud-init started at $(date)\" \u003e\u003e /var/log/ai-setup.log\n\n  # Install Docker CE from official repository\n  - install -m 0755 -d /etc/apt/keyrings\n  - curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc\n  - chmod a+r /etc/apt/keyrings/docker.asc\n  - |\n    echo \"deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian $(. /etc/os-release \u0026\u0026 echo $VERSION_CODENAME) stable\" | tee /etc/apt/sources.list.d/docker.list \u003e /dev/null\n  - apt-get update\n  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin\n  - usermod -aG docker ai\n  - systemctl enable docker\n  - systemctl start docker\n\n  # Create letsencrypt directories\n  - mkdir -p /etc/letsencrypt/renewal-hooks/deploy\n\n  # Get Let's Encrypt certificate\n  - |\n    certbot certonly \\\n      --dns-cloudflare \\\n      --dns-cloudflare-credentials /etc/letsencrypt/cloudflare.ini \\\n      -d ai.internal.prakash.com.br \\\n      --non-interactive \\\n      --agree-tos \\\n      -m contato@prakash.com.br\n  - systemctl reload nginx\n\n  # Configure nginx\n  - rm -f /etc/nginx/sites-enabled/default\n  - ln -sf /etc/nginx/sites-available/ai /etc/nginx/sites-enabled/ai\n  - systemctl enable nginx\n  - systemctl start nginx\n\n  # Install Promtail for log shipping\n  - /opt/ai/install-promtail.sh\n\n  # Enable and start setup service\n  - systemctl daemon-reload\n  - systemctl enable ai-setup.service\n  - systemctl start ai-setup.service\n",
                "file_name": "ai-cloud-init.yaml",
                "resize": 0
              }
            ],
            "timeout_upload": 1800
          },
          "sensitive_attributes": [
            [
              {
                "type": "get_attr",
                "value": "source_raw"
              },
              {
                "type": "index",
                "value": {
                  "value": 0,
                  "type": "number"
                }
              },
              {
                "type": "get_attr",
                "value": "data"
              }
            ]
          ],
          "identity_schema_version": 0,
          "private": "bnVsbA=="
        }
      ]
    },
    {
      "mode": "managed",
      "type": "proxmox_virtual_environment_file",
      "name": "infisical_cloud_init",
      "provider": "provider[\"registry.terraform.io/bpg/proxmox\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "content_type": "snippets",
            "datastore_id": "local",
            "file_mode": null,
            "file_modification_date": null,
            "file_name": "infisical-cloud-init.yaml",
            "file_size": null,
            "file_tag": null,
            "id": "local:snippets/infisical-cloud-init.yaml",
            "node_name": "server",
            "overwrite": true,
            "source_file": [],
            "source_raw": [
              {
                "data": "#cloud-config\n\n# Set hostname early (before packages install)\nhostname: infisical\nmanage_etc_hosts: true\n\npackage_update: true\npackage_upgrade: true\n\npackages:\n  - ca-certificates\n  - curl\n  - gnupg\n  - avahi-daemon\n\nwrite_files:\n  - path: /opt/infisical/docker-compose.yml\n    permissions: '0644'\n    content: |\n      version: \"3.9\"\n\n      services:\n        redis:\n          image: redis:7-alpine\n          container_name: infisical-redis\n          restart: unless-stopped\n          volumes:\n            - redis_data:/data\n          healthcheck:\n            test: [\"CMD\", \"redis-cli\", \"ping\"]\n            interval: 10s\n            timeout: 5s\n            retries: 5\n\n        infisical:\n          image: infisical/infisical:latest\n          container_name: infisical\n          restart: unless-stopped\n          ports:\n            - \"8080:8080\"\n          environment:\n            - NODE_ENV=production\n            - ENCRYPTION_KEY=34d19614f7de46fec34763e98cb1648d\n            - AUTH_SECRET=+tXmLH8ByVq0x2YyAPg7jB4OHW6n9HsmL8ZJIkoPvbw=\n            - DB_CONNECTION_URI=postgres://infisical:laEBe7ZLvNPBADCvYH9ei4mQz3ZVk%2FWN@192.168.20.21:5432/infisical\n            - REDIS_URL=redis://redis:6379\n            - SITE_URL=https://192.168.20.22:8443\n            - TELEMETRY_ENABLED=false\n          depends_on:\n            redis:\n              condition: service_healthy\n          healthcheck:\n            test: [\"CMD\", \"curl\", \"-f\", \"http://localhost:8080/api/status\"]\n            interval: 30s\n            timeout: 10s\n            retries: 5\n\n        nginx:\n          image: nginx:alpine\n          container_name: infisical-nginx\n          restart: unless-stopped\n          ports:\n            - \"443:443\"\n          volumes:\n            - ./nginx.conf:/etc/nginx/nginx.conf:ro\n            - ./certs:/etc/nginx/certs:ro\n          depends_on:\n            - infisical\n          healthcheck:\n            test: [\"CMD\", \"wget\", \"-q\", \"--spider\", \"http://localhost:80/health\"]\n            interval: 30s\n            timeout: 10s\n            retries: 3\n\n      volumes:\n        redis_data:\n\n      networks:\n        default:\n          name: infisical-network\n\n  - path: /opt/infisical/.env\n    permissions: '0600'\n    content: |\n      # Infisical environment - managed by Terraform\n      ENCRYPTION_KEY=34d19614f7de46fec34763e98cb1648d\n      AUTH_SECRET=+tXmLH8ByVq0x2YyAPg7jB4OHW6n9HsmL8ZJIkoPvbw=\n      POSTGRES_HOST=192.168.20.21\n      POSTGRES_PORT=5432\n      POSTGRES_DB=infisical\n      POSTGRES_USER=infisical\n      POSTGRES_PASSWORD=laEBe7ZLvNPBADCvYH9ei4mQz3ZVk/WN\n\n  - path: /opt/infisical/nginx.conf\n    permissions: '0644'\n    content: |\n      events {\n          worker_connections 1024;\n      }\n\n      http {\n          upstream infisical {\n              server infisical:8080;\n          }\n\n          server {\n              listen 80;\n              location /health {\n                  return 200 'ok';\n                  add_header Content-Type text/plain;\n              }\n              location / {\n                  return 301 https://$host$request_uri;\n              }\n          }\n\n          server {\n              listen 443 ssl;\n              server_name infisical.local;\n\n              ssl_certificate /etc/nginx/certs/cert.pem;\n              ssl_certificate_key /etc/nginx/certs/key.pem;\n              ssl_protocols TLSv1.2 TLSv1.3;\n              ssl_ciphers HIGH:!aNULL:!MD5;\n\n              location / {\n                  proxy_pass http://infisical;\n                  proxy_set_header Host $host;\n                  proxy_set_header X-Real-IP $remote_addr;\n                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n                  proxy_set_header X-Forwarded-Proto $scheme;\n\n                  # WebSocket support\n                  proxy_http_version 1.1;\n                  proxy_set_header Upgrade $http_upgrade;\n                  proxy_set_header Connection \"upgrade\";\n              }\n          }\n      }\n\n  - path: /etc/systemd/system/infisical.service\n    permissions: '0644'\n    content: |\n      [Unit]\n      Description=Infisical Secret Management\n      Requires=docker.service\n      After=docker.service\n\n      [Service]\n      Type=oneshot\n      RemainAfterExit=yes\n      WorkingDirectory=/opt/infisical\n      ExecStart=/usr/bin/docker compose up -d\n      ExecStop=/usr/bin/docker compose down\n\n      [Install]\n      WantedBy=multi-user.target\n\n  - path: /opt/infisical/certs/cert.pem\n    permissions: '0644'\n    content: |\n      -----BEGIN CERTIFICATE-----\n      MIIElDCCAvygAwIBAgIRAPRhVyAQwX8KazirE3Zrzc0wDQYJKoZIhvcNAQELBQAw\n      gakxHjAcBgNVBAoTFW1rY2VydCBkZXZlbG9wbWVudCBDQTE/MD0GA1UECww2cHJh\n      a2FzaEBNYWNCb29rLVByby1NMy1kZS1QcmFrYXNoLmxvY2FsIChQcmFrYXNoIFBy\n      ZW0pMUYwRAYDVQQDDD1ta2NlcnQgcHJha2FzaEBNYWNCb29rLVByby1NMy1kZS1Q\n      cmFrYXNoLmxvY2FsIChQcmFrYXNoIFByZW0pMB4XDTI2MDExMDE2NDEyOFoXDTI4\n      MDQxMDE2NDEyOFowajEnMCUGA1UEChMebWtjZXJ0IGRldmVsb3BtZW50IGNlcnRp\n      ZmljYXRlMT8wPQYDVQQLDDZwcmFrYXNoQE1hY0Jvb2stUHJvLU0zLWRlLVByYWth\n      c2gubG9jYWwgKFByYWthc2ggUHJlbSkwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAw\n      ggEKAoIBAQCukN/HYCeZp2W7MRhHZNaiWlzvYm85hkdkXXCspwOcCGOupDAUKIlO\n      ygVxueXJQQE0X4G3TmWFePldRMyhPQSzN9q/R6WC5+omvWHe5mnRx4zqauwNrEF9\n      ELgwVaqzKVpyQHo556KgfrEbMSO7cVdSQuPmIGA9+AHQbc9f2Z3z17sntTTbvNaX\n      668Zjl5K/h5eqAZHrdNc2VHtUTVEqdtPW5t8ySZ6Zxqq4SrEavMSX8HfI3FBe4u0\n      8R28Ivr6a09qbXlDfgdq+blRcMYnK2eeAmKFgB2woOW7wj/TCMzTm95TIHXrhwep\n      t88rzLVUm6TcP3s2MaMMTSqLEXP/wGXPAgMBAAGjdTBzMA4GA1UdDwEB/wQEAwIF\n      oDATBgNVHSUEDDAKBggrBgEFBQcDATAfBgNVHSMEGDAWgBTBE5p1B2rilKWfz3pV\n      699bwgJ/ADArBgNVHREEJDAigg9pbmZpc2ljYWwubG9jYWyCCWxvY2FsaG9zdIcE\n      wKgUFjANBgkqhkiG9w0BAQsFAAOCAYEAAgaDIpHFZGHpDe+lfW2N6/rV+S4BjMqK\n      pio83jQc6pwrsrHRj4aGI/IxywsPBr7jIm5W8Mcpk7Hn4+aaiJap6agyqKrvCKiz\n      SsCVVuz/9UR0LDqJ+AxscgFaC/3q3bNTJ4FxP3KimsItoB6vEuKQ0n67jLuNcZQo\n      yfReZxppdi7PX1CG4dqMKDxRMV62GOiTU4c8Puqbvjg3pSF9nM9j7/hV5mbxh0UB\n      2wwIab2+x1uEHEP8ESM7RWKm92RbLg+kVOnoWigfn2/wITS+Kf6k2vV/TXSQJyrL\n      Rdk9M0YSa9gO68GC3KTwu7qVHjfoxOXo51nuZsEZi9mWMYaghSa0c2ptm66Bb7f+\n      u+l2SNPBqmMWzW6Au6PFmM8AbEfynrTNpPM+aEiep4psb8UxRjlmoonzmauHFS5c\n      imbrDfOzT+WH+C9wZDrEPxwewWvpv9C/qAuN72QoinebBb0rKrPqutDoPJ7dKQtH\n      uw7wfPhQQ8gYY8tPXQ+3TEtKkvSZuUzb\n      -----END CERTIFICATE-----\n      \n\n  - path: /opt/infisical/certs/key.pem\n    permissions: '0600'\n    content: |\n      -----BEGIN PRIVATE KEY-----\n      MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQCukN/HYCeZp2W7\n      MRhHZNaiWlzvYm85hkdkXXCspwOcCGOupDAUKIlOygVxueXJQQE0X4G3TmWFePld\n      RMyhPQSzN9q/R6WC5+omvWHe5mnRx4zqauwNrEF9ELgwVaqzKVpyQHo556KgfrEb\n      MSO7cVdSQuPmIGA9+AHQbc9f2Z3z17sntTTbvNaX668Zjl5K/h5eqAZHrdNc2VHt\n      UTVEqdtPW5t8ySZ6Zxqq4SrEavMSX8HfI3FBe4u08R28Ivr6a09qbXlDfgdq+blR\n      cMYnK2eeAmKFgB2woOW7wj/TCMzTm95TIHXrhwept88rzLVUm6TcP3s2MaMMTSqL\n      EXP/wGXPAgMBAAECggEAAdXx0ZW96TrsyWbh8u76oEu4Pqd6nZZWiyFgyPRhB8rv\n      4iV0DFgJ4CfHhw8XTuI32AZVFyap/hkO8Ssl9NR6zVryYAl7TF3vELOXI0Cpl6uc\n      6AVyMGaesgvnazn58aiPwqhdSWj2ojX7leYSqdl/6gi5fytk5j8EyAwPkwiOXMLk\n      MJOvcGqJ0gJtqO8+SINtEq+U1Qmti++fSchZvxrXgvpvqYWFsuBEFK8BbbnuBkB9\n      3+LPYV/dhUqIBhhwPJqemKo+UQPY0tkpka2aRoiTUuEnqs8LhD66RA8LSIUsLFsV\n      07OniGx4F20Sp+R1Q0GUvBUnSA1gYW54DOoR9h+GGQKBgQDjwNJORDrdkYq6Y4FY\n      atE7+KTx7wBDWCTTL36nJQBqfDhtVcdIJtD17NIFv1hPzXv1XaygoURQRoq5WZXo\n      mbE/Y6pQmWQjnXjpy8YYgi2MzrVChO0RNhDFGMelHBRF054IYi6UjwNxy/UJxSuI\n      MQst64Xe4/0c/sVGbRHdUu7KswKBgQDEN1pM+XHyM+hjvh+vAwf+aywEafsMDxOs\n      UFf7KYpHl7Cz/j9hb+5265S5s46pR6t1pcf/QmH9CUcBYP6uX4fgI1s50wB0WCmQ\n      +W3pdzkSBXUJ/6JtfVe2g34kJWDNWKxaBZntWp9Jc/hdgflBPHE7ZWdIVGRhwV70\n      DHYg/LQ2dQKBgH22/p8DHHcXEjtmF4yFka8HxYxhv4Rs0A7eRYvfacZdgQwg8BpM\n      isVkjl1rzERoiUbcCSC1Q68H8ST0ZUH6LBNwYR+SO+tIzehHebYnjRsPMpBgLTd1\n      33XcAr+Jq0sLz0yTXWDVPDKBQWW+NxQ69g/H1KI+uIVbv+rq45SGZZbvAoGBAKRL\n      YN4RA9r0ocJaoLbvB9N9M2ciwmWPfj6LK5APcUyO9BNScQmKKpcCnQ59DZgqfaPN\n      w0+16sxv5zd9WuLw9Jm1oR4i0j+Yzn0ojWKuRGgVj7Fmjj+1cytMoONtNMfcVrwt\n      8nwupC9h3nWVbfq0vG8qcje7Ci5cNsCMaqEmV1M9AoGBALNNB2VWkppOvhkLqslp\n      CafOEeG3nlGyBDwJnFBB2GDSANWuhXVEFd4yQwQVzreNnqGRgI8FE+bZWN3UuUDf\n      LcucvXnjkqz1GhTAHcysBQAk5WvYQw4q38/FU3/jkbWb9RoIDFI79q5CSqM3QYIJ\n      vV0zti7tCdj4t4c2YGgIsaQs\n      -----END PRIVATE KEY-----\n      \n\nruncmd:\n  # Ensure avahi is enabled (hostname already set via cloud-init)\n  - systemctl enable avahi-daemon\n  - systemctl restart avahi-daemon\n\n  # Install Docker\n  - install -m 0755 -d /etc/apt/keyrings\n  - curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc\n  - chmod a+r /etc/apt/keyrings/docker.asc\n  - echo \"deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian $(. /etc/os-release \u0026\u0026 echo \"$VERSION_CODENAME\") stable\" | tee /etc/apt/sources.list.d/docker.list \u003e /dev/null\n  - apt-get update\n  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin\n\n  # Add deployer user to docker group\n  - usermod -aG docker deployer\n\n  # Enable and start Docker\n  - systemctl enable docker\n  - systemctl start docker\n\n  # Wait for Docker to be ready\n  - sleep 10\n\n  # Enable and start Infisical\n  - systemctl daemon-reload\n  - systemctl enable infisical\n  - systemctl start infisical\n\nfinal_message: \"Infisical server is ready! Access at https://$INSTANCE_IP:8443\"\n",
                "file_name": "infisical-cloud-init.yaml",
                "resize": 0
              }
            ],
            "timeout_upload": 1800
          },
          "sensitive_attributes": [
            [
              {
                "type": "get_attr",
                "value": "source_raw"
              },
              {
                "type": "index",
                "value": {
                  "value": 0,
                  "type": "number"
                }
              },
              {
                "type": "get_attr",
                "value": "data"
              }
            ]
          ],
          "identity_schema_version": 0,
          "private": "bnVsbA=="
        }
      ]
    },
    {
      "mode": "managed",
      "type": "proxmox_virtual_environment_file",
      "name": "postgres_cloud_init",
      "provider": "provider[\"registry.terraform.io/bpg/proxmox\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "content_type": "snippets",
            "datastore_id": "local",
            "file_mode": null,
            "file_modification_date": null,
            "file_name": "postgres-cloud-init.yaml",
            "file_size": null,
            "file_tag": null,
            "id": "local:snippets/postgres-cloud-init.yaml",
            "node_name": "server",
            "overwrite": true,
            "source_file": [],
            "source_raw": [
              {
                "data": "#cloud-config\n\n# Set hostname early (before packages install)\nhostname: pg\nmanage_etc_hosts: true\n\npackage_update: true\npackage_upgrade: true\n\npackages:\n  - wget\n  - ca-certificates\n  - gnupg\n  - lsb-release\n  - avahi-daemon\n\nwrite_files:\n  - path: /etc/apt/keyrings/.placeholder\n    permissions: '0644'\n    content: |\n      # Placeholder for keyrings directory\n\nruncmd:\n  # Ensure avahi is enabled (hostname already set via cloud-init)\n  - systemctl enable avahi-daemon\n  - systemctl restart avahi-daemon\n\n  # Setup data disk for PostgreSQL (/dev/sdb -\u003e /data)\n  - |\n    if [ -b /dev/sdb ] \u0026\u0026 ! blkid /dev/sdb; then\n      echo \"Formatting data disk...\"\n      mkfs.ext4 -L pgdata /dev/sdb\n    fi\n  - mkdir -p /data\n  - |\n    if ! grep -q '/data' /etc/fstab; then\n      echo 'LABEL=pgdata /data ext4 defaults,noatime 0 2' \u003e\u003e /etc/fstab\n    fi\n  - mount -a\n\n  # Add PostgreSQL official APT repository\n  - wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | gpg --dearmor -o /etc/apt/keyrings/postgresql.gpg\n  - chmod 644 /etc/apt/keyrings/postgresql.gpg\n  - echo \"deb [signed-by=/etc/apt/keyrings/postgresql.gpg] http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main\" | tee /etc/apt/sources.list.d/pgdg.list \u003e /dev/null\n\n  # Update and install PostgreSQL\n  - apt-get update\n  - apt-get install -y postgresql-17 postgresql-contrib-17\n\n  # Stop PostgreSQL to move data directory\n  - systemctl stop postgresql\n\n  # Move PostgreSQL data to /data if not already there\n  - |\n    if [ ! -d /data/postgresql ]; then\n      mkdir -p /data/postgresql\n      chown postgres:postgres /data/postgresql\n      chmod 700 /data/postgresql\n      # Move existing data\n      if [ -d /var/lib/postgresql/17/main ]; then\n        mv /var/lib/postgresql/17/main /data/postgresql/17_main\n      else\n        mkdir -p /data/postgresql/17_main\n        chown postgres:postgres /data/postgresql/17_main\n        chmod 700 /data/postgresql/17_main\n      fi\n    fi\n\n  # Update PostgreSQL config to use /data\n  - sed -i \"s|data_directory = '/var/lib/postgresql/17/main'|data_directory = '/data/postgresql/17_main'|\" /etc/postgresql/17/main/postgresql.conf\n\n  # Configure PostgreSQL to listen on all interfaces\n  - cp /etc/postgresql/17/main/postgresql.conf /etc/postgresql/17/main/postgresql.conf.bak\n  - sed -i \"s/#listen_addresses = 'localhost'/listen_addresses = '*'/\" /etc/postgresql/17/main/postgresql.conf\n\n  # Configure pg_hba.conf to allow connections from local network\n  - echo \"\" \u003e\u003e /etc/postgresql/17/main/pg_hba.conf\n  - echo \"# Allow connections from local network\" \u003e\u003e /etc/postgresql/17/main/pg_hba.conf\n  - echo \"host    all             all             192.168.20.0/24          md5\" \u003e\u003e /etc/postgresql/17/main/pg_hba.conf\n\n  # Initialize database if needed (new data disk)\n  - |\n    if [ ! -f /data/postgresql/17_main/PG_VERSION ]; then\n      sudo -u postgres /usr/lib/postgresql/17/bin/initdb -D /data/postgresql/17_main\n    fi\n\n  # Start PostgreSQL\n  - systemctl start postgresql\n  - systemctl enable postgresql\n\nfinal_message: \"PostgreSQL 17 server is ready at pg.local (data on /data)\"\n",
                "file_name": "postgres-cloud-init.yaml",
                "resize": 0
              }
            ],
            "timeout_upload": 1800
          },
          "sensitive_attributes": [],
          "identity_schema_version": 0,
          "private": "bnVsbA=="
        }
      ]
    },
    {
      "mode": "managed",
      "type": "proxmox_virtual_environment_file",
      "name": "whisper_cloud_init",
      "provider": "provider[\"registry.terraform.io/bpg/proxmox\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "content_type": "snippets",
            "datastore_id": "local",
            "file_mode": null,
            "file_modification_date": null,
            "file_name": "whisper-cloud-init.yaml",
            "file_size": null,
            "file_tag": null,
            "id": "local:snippets/whisper-cloud-init.yaml",
            "node_name": "server",
            "overwrite": true,
            "source_file": [],
            "source_raw": [
              {
                "data": "#cloud-config\n# Whisper GPU Inference Server (Docker-based)\n# Requires: debian-12-nvidia template (NVIDIA drivers pre-installed)\n# Sets up: Docker, NVIDIA Container Toolkit, Whisper API container, Watchtower for auto-updates\n\nhostname: whisper\nmanage_etc_hosts: true\n\npackage_update: true\npackage_upgrade: false\n\npackages:\n  - ca-certificates\n  - curl\n  - gnupg\n  - git\n  - wget\n  - htop\n  - unzip\n  - nginx\n  - certbot\n  - python3-certbot-dns-cloudflare\n\nusers:\n  - default\n  - name: whisper\n    groups: [sudo, video, render, docker]\n    shell: /bin/bash\n    sudo: ALL=(ALL) NOPASSWD:ALL\n\nwrite_files:\n  # Cloudflare credentials for Let's Encrypt\n  - path: /etc/letsencrypt/cloudflare.ini\n    permissions: \"0600\"\n    content: |\n      dns_cloudflare_api_token = Og7UTeuQqILzmS6sYHXDb4TYTSISnQDJC1xkPS99\n\n  # Nginx configuration\n  - path: /etc/nginx/sites-available/whisper\n    permissions: \"0644\"\n    content: |\n      server {\n          listen 80;\n          server_name whisper.internal.prakash.com.br;\n\n          location / {\n              return 301 https://$host$request_uri;\n          }\n      }\n\n      server {\n          listen 443 ssl;\n          server_name whisper.internal.prakash.com.br;\n\n          ssl_certificate /etc/letsencrypt/live/whisper.internal.prakash.com.br/fullchain.pem;\n          ssl_certificate_key /etc/letsencrypt/live/whisper.internal.prakash.com.br/privkey.pem;\n          ssl_protocols TLSv1.2 TLSv1.3;\n          ssl_ciphers HIGH:!aNULL:!MD5;\n\n          client_max_body_size 100M;\n\n          location / {\n              proxy_pass http://127.0.0.1:8000;\n              proxy_set_header Host $host;\n              proxy_set_header X-Real-IP $remote_addr;\n              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;\n              proxy_set_header X-Forwarded-Proto $scheme;\n\n              # Extended timeouts for queued requests and long audio processing\n              proxy_read_timeout 600s;\n              proxy_connect_timeout 60s;\n              proxy_send_timeout 600s;\n\n              # Disable buffering for better streaming behavior\n              proxy_buffering off;\n              proxy_request_buffering off;\n          }\n      }\n\n  # Cert renewal hook\n  - path: /etc/letsencrypt/renewal-hooks/deploy/reload-nginx.sh\n    permissions: \"0755\"\n    content: |\n      #!/bin/bash\n      systemctl reload nginx\n\n  # Docker Compose configuration for Whisper API + Watchtower\n  - path: /opt/whisper/docker-compose.yaml\n    permissions: \"0644\"\n    content: |\n      services:\n        whisper-api:\n          image: ghcr.io/prem-prakash/whisper-api:latest\n          container_name: whisper-api\n          restart: unless-stopped\n          ports:\n            - \"127.0.0.1:8000:8000\"\n          volumes:\n            - whisper-cache:/app/.cache\n          environment:\n            - WHISPER_MODEL=turbo\n            - WHISPER_DEVICE=cuda\n            - XDG_CACHE_HOME=/app/.cache\n          deploy:\n            resources:\n              reservations:\n                devices:\n                  - driver: nvidia\n                    count: 1\n                    capabilities: [gpu]\n          logging:\n            driver: json-file\n            options:\n              max-size: \"10m\"\n              max-file: \"3\"\n\n        watchtower:\n          image: nickfedor/watchtower\n          container_name: watchtower\n          restart: unless-stopped\n          volumes:\n            - /var/run/docker.sock:/var/run/docker.sock\n            - /home/whisper/.docker/config.json:/config.json:ro\n          environment:\n            - WATCHTOWER_CLEANUP=true\n            - WATCHTOWER_POLL_INTERVAL=300\n            - WATCHTOWER_INCLUDE_STOPPED=false\n            - DOCKER_CONFIG=/\n          command: whisper-api\n      volumes:                   # \u003c-- ADD THIS at the end\n        whisper-cache:\n\n  # Main setup script - runs once on first boot\n  - path: /opt/whisper/setup.sh\n    permissions: \"0755\"\n    content: |\n      #!/bin/bash\n      # Whisper API Docker Setup Script\n      # NVIDIA drivers are pre-installed in the template\n\n      LOG_FILE=\"/var/log/whisper-setup.log\"\n      exec \u003e \u003e(tee -a \"$LOG_FILE\") 2\u003e\u00261\n\n      echo \"\"\n      echo \"==========================================\"\n      echo \"Whisper Docker Setup - $(date)\"\n      echo \"==========================================\"\n\n      SETUP_COMPLETE=\"/opt/whisper/.setup_complete\"\n\n      # If setup is complete, exit\n      if [ -f \"$SETUP_COMPLETE\" ]; then\n          echo \"Setup already complete.\"\n          exit 0\n      fi\n\n      # Verify GPU is available\n      echo \"\"\n      echo \"=== Checking GPU ===\"\n      if ! nvidia-smi; then\n          echo \"ERROR: NVIDIA GPU not detected!\"\n          echo \"Make sure you're using the debian-12-nvidia template\"\n          echo \"and GPU passthrough is configured correctly.\"\n          exit 1\n      fi\n\n      echo \"\"\n      echo \"GPU detected:\"\n      nvidia-smi --query-gpu=name,memory.total,driver_version --format=csv\n\n      # Install NVIDIA Container Toolkit\n      echo \"\"\n      echo \"=== Installing NVIDIA Container Toolkit ===\"\n      if ! command -v nvidia-ctk \u0026\u003e /dev/null; then\n          curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg\n          curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \\\n              sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \\\n              tee /etc/apt/sources.list.d/nvidia-container-toolkit.list\n          apt-get update\n          apt-get install -y nvidia-container-toolkit\n          nvidia-ctk runtime configure --runtime=docker\n          systemctl restart docker\n          echo \"NVIDIA Container Toolkit installed\"\n      else\n          echo \"NVIDIA Container Toolkit already installed\"\n      fi\n\n      # Setup GHCR authentication\n      echo \"\"\n      echo \"=== Configuring GHCR authentication ===\"\n      mkdir -p /home/whisper/.docker\n      echo '{\"auths\":{\"ghcr.io\":{\"auth\":\"cHJlbS1wcmFrYXNoOmdocF9Kc0xyNGdCSlFTdWxZRWxZenR1ejZidEFEbnhKdmMyNkY5VXk=\"}}}' \u003e /home/whisper/.docker/config.json\n      chown -R whisper:whisper /home/whisper/.docker\n      chmod 600 /home/whisper/.docker/config.json\n      echo \"GHCR authentication configured\"\n\n      # Ensure ownership\n      chown -R whisper:whisper /opt/whisper\n\n      # Pull and start containers\n      echo \"\"\n      echo \"=== Starting Whisper API containers ===\"\n      cd /opt/whisper\n      sudo -u whisper docker compose pull\n      sudo -u whisper docker compose up -d\n\n      # Wait for API to be ready\n      echo \"\"\n      echo \"=== Waiting for API to be ready ===\"\n      for i in {1..60}; do\n          if curl -s http://localhost:8000/health | grep -q \"healthy\"; then\n              break\n          fi\n          echo \"Waiting... ($i/60)\"\n          sleep 5\n      done\n\n      # Verify setup\n      if curl -s http://localhost:8000/health | grep -q \"healthy\"; then\n          touch \"$SETUP_COMPLETE\"\n          chown whisper:whisper \"$SETUP_COMPLETE\"\n\n          echo \"\"\n          echo \"==========================================\"\n          echo \"SETUP COMPLETE!\"\n          echo \"==========================================\"\n          echo \"\"\n          echo \"Whisper API: https://whisper.internal.prakash.com.br\"\n          echo \"Health check: curl https://whisper.internal.prakash.com.br/health\"\n          echo \"Queue status: curl https://whisper.internal.prakash.com.br/queue/status\"\n          echo \"\"\n\n          # Disable setup service\n          systemctl disable whisper-setup.service\n      else\n          echo \"ERROR: Whisper API failed to start\"\n          docker compose logs whisper-api\n          exit 1\n      fi\n\n  # Systemd service for setup (runs once on first boot)\n  - path: /etc/systemd/system/whisper-setup.service\n    permissions: \"0644\"\n    content: |\n      [Unit]\n      Description=Whisper API Docker Setup\n      After=network-online.target docker.service\n      Wants=network-online.target\n      Requires=docker.service\n\n      [Service]\n      Type=oneshot\n      ExecStart=/opt/whisper/setup.sh\n      RemainAfterExit=yes\n      StandardOutput=journal+console\n      StandardError=journal+console\n\n      [Install]\n      WantedBy=multi-user.target\n\n  # Promtail configuration for shipping logs to Loki (updated for Docker)\n  - path: /etc/promtail/config.yaml\n    permissions: \"0644\"\n    content: |\n      server:\n        http_listen_port: 9080\n        grpc_listen_port: 0\n\n      positions:\n        filename: /var/lib/promtail/positions.yaml\n\n      clients:\n        - url: http://192.168.20.11:31100/loki/api/v1/push\n\n      scrape_configs:\n        # Scrape Docker container logs\n        - job_name: docker\n          docker_sd_configs:\n            - host: unix:///var/run/docker.sock\n              refresh_interval: 5s\n          relabel_configs:\n            - target_label: job\n              replacement: docker\n            - source_labels: ['__meta_docker_container_name']\n              regex: '/(.+)'\n              target_label: container\n            - source_labels: ['__meta_docker_container_name']\n              regex: '/(whisper-api|watchtower)'\n              action: keep\n            - source_labels: ['__meta_docker_container_label_com_docker_compose_service']\n              target_label: compose_service\n            - source_labels: ['__meta_docker_container_label_com_docker_compose_project']\n              target_label: compose_project\n            - source_labels: ['__meta_docker_container_label_com_docker_compose_service']\n              target_label: service_name\n            - source_labels: ['__meta_docker_container_id']\n              target_label: __path__\n              replacement: /var/lib/docker/containers/$1/$1-json.log\n            - action: labelkeep\n              regex: '^(job|container|compose_service|compose_project|service_name)$'\n          pipeline_stages:\n            - json:\n                expressions:\n                  log: log\n                  stream: stream\n                  time: time\n            - output:\n                source: log\n\n        - job_name: system\n          journal:\n            max_age: 12h\n            labels:\n              job: system\n              host: whisper-gpu\n          relabel_configs:\n            - source_labels: ['__journal__systemd_unit']\n              regex: '(sshd|systemd-.*|nvidia-.*|docker.*)\\.service'\n              action: keep\n            - source_labels: ['__journal__systemd_unit']\n              target_label: unit\n            - source_labels: ['__journal_priority_keyword']\n              target_label: level\n\n  # Systemd service for Promtail\n  - path: /etc/systemd/system/promtail.service\n    permissions: \"0644\"\n    content: |\n      [Unit]\n      Description=Promtail Log Collector\n      After=network-online.target docker.service\n      Wants=network-online.target\n\n      [Service]\n      Type=simple\n      User=root\n      ExecStart=/usr/local/bin/promtail -config.file=/etc/promtail/config.yaml\n      Restart=always\n      RestartSec=10\n\n      [Install]\n      WantedBy=multi-user.target\n\n  # Promtail installation script\n  - path: /opt/whisper/install-promtail.sh\n    permissions: \"0755\"\n    content: |\n      #!/bin/bash\n      set -e\n\n      PROMTAIL_VERSION=\"3.6.3\"\n      ARCH=\"amd64\"\n\n      echo \"Installing Promtail ${PROMTAIL_VERSION}...\"\n\n      cd /tmp\n      wget -q \"https://github.com/grafana/loki/releases/download/v${PROMTAIL_VERSION}/promtail-linux-${ARCH}.zip\"\n      unzip -o \"promtail-linux-${ARCH}.zip\"\n      chmod +x \"promtail-linux-${ARCH}\"\n      mv \"promtail-linux-${ARCH}\" /usr/local/bin/promtail\n      rm -f \"promtail-linux-${ARCH}.zip\"\n\n      mkdir -p /var/lib/promtail\n      mkdir -p /etc/promtail\n\n      systemctl daemon-reload\n      systemctl enable promtail\n      systemctl start promtail\n\n      echo \"Promtail installed and started!\"\n\nruncmd:\n  - mkdir -p /opt/whisper\n  - chown -R whisper:whisper /opt/whisper\n  - echo \"Whisper cloud-init started at $(date)\" \u003e\u003e /var/log/whisper-setup.log\n\n  # Install Docker CE from official repository\n  - install -m 0755 -d /etc/apt/keyrings\n  - curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc\n  - chmod a+r /etc/apt/keyrings/docker.asc\n  - |\n    echo \"deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian $(. /etc/os-release \u0026\u0026 echo $VERSION_CODENAME) stable\" | tee /etc/apt/sources.list.d/docker.list \u003e /dev/null\n  - apt-get update\n  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin\n  - usermod -aG docker whisper\n  - systemctl enable docker\n  - systemctl start docker\n\n  # Create letsencrypt directories\n  - mkdir -p /etc/letsencrypt/renewal-hooks/deploy\n\n  # Get Let's Encrypt certificate\n  - |\n    certbot certonly \\\n      --dns-cloudflare \\\n      --dns-cloudflare-credentials /etc/letsencrypt/cloudflare.ini \\\n      -d whisper.internal.prakash.com.br \\\n      --non-interactive \\\n      --agree-tos \\\n      -m contato@prakash.com.br\n  - systemctl reload nginx\n\n  # Configure nginx\n  - rm -f /etc/nginx/sites-enabled/default\n  - ln -sf /etc/nginx/sites-available/whisper /etc/nginx/sites-enabled/whisper\n  - systemctl enable nginx\n  - systemctl start nginx\n\n  # Install Promtail for log shipping\n  - /opt/whisper/install-promtail.sh\n\n  # Enable and start setup service\n  - systemctl daemon-reload\n  - systemctl enable whisper-setup.service\n  - systemctl start whisper-setup.service\n",
                "file_name": "whisper-cloud-init.yaml",
                "resize": 0
              }
            ],
            "timeout_upload": 1800
          },
          "sensitive_attributes": [
            [
              {
                "type": "get_attr",
                "value": "source_raw"
              },
              {
                "type": "index",
                "value": {
                  "value": 0,
                  "type": "number"
                }
              },
              {
                "type": "get_attr",
                "value": "data"
              }
            ]
          ],
          "identity_schema_version": 0,
          "private": "bnVsbA=="
        }
      ]
    },
    {
      "mode": "managed",
      "type": "proxmox_virtual_environment_vm",
      "name": "ai_gpu",
      "provider": "provider[\"registry.terraform.io/bpg/proxmox\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "acpi": true,
            "agent": [],
            "amd_sev": [],
            "audio_device": [],
            "bios": "ovmf",
            "boot_order": [],
            "cdrom": [],
            "clone": [
              {
                "datastore_id": "",
                "full": true,
                "node_name": "server",
                "retries": 1,
                "vm_id": 9003
              }
            ],
            "cpu": [
              {
                "affinity": "",
                "architecture": "",
                "cores": 4,
                "flags": null,
                "hotplugged": 0,
                "limit": 0,
                "numa": false,
                "sockets": 1,
                "type": "host",
                "units": 0
              }
            ],
            "delete_unreferenced_disks_on_destroy": true,
            "description": "AI inference server (Whisper + Ollama) with GPU passthrough",
            "disk": [
              {
                "aio": "io_uring",
                "backup": true,
                "cache": "none",
                "datastore_id": "local-lvm",
                "discard": "ignore",
                "file_format": "raw",
                "file_id": "",
                "import_from": "",
                "interface": "scsi0",
                "iothread": false,
                "path_in_datastore": "vm-115-disk-1",
                "replicate": true,
                "serial": "",
                "size": 60,
                "speed": [],
                "ssd": false
              }
            ],
            "efi_disk": [
              {
                "datastore_id": "local-lvm",
                "file_format": "raw",
                "pre_enrolled_keys": false,
                "type": "4m"
              }
            ],
            "hook_script_file_id": null,
            "hostpci": [
              {
                "device": "hostpci0",
                "id": "",
                "mapping": "gpu-quadro-m4000",
                "mdev": "",
                "pcie": true,
                "rom_file": "",
                "rombar": true,
                "xvga": false
              }
            ],
            "id": "115",
            "initialization": [
              {
                "datastore_id": "local-lvm",
                "dns": [
                  {
                    "domain": "",
                    "servers": [
                      "1.1.1.1"
                    ]
                  }
                ],
                "file_format": "",
                "interface": "ide2",
                "ip_config": [
                  {
                    "ipv4": [
                      {
                        "address": "192.168.20.30/24",
                        "gateway": "192.168.20.1"
                      }
                    ],
                    "ipv6": []
                  }
                ],
                "meta_data_file_id": "",
                "network_data_file_id": "",
                "type": "",
                "user_account": [
                  {
                    "keys": [
                      "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAhLzivPgJGOMkfj6Fg8WBbPvJIMLQHjpFTnXZVsncBg prakash2ji@gmail.com"
                    ],
                    "password": "**********",
                    "username": "deployer"
                  }
                ],
                "user_data_file_id": "local:snippets/ai-cloud-init.yaml",
                "vendor_data_file_id": ""
              }
            ],
            "ipv4_addresses": [
              [
                "127.0.0.1"
              ],
              [
                "192.168.20.30"
              ]
            ],
            "ipv6_addresses": [
              [
                "::1"
              ],
              [
                "fdd5:945b:3322::43b",
                "fdd5:945b:3322:0:be24:11ff:fe92:db53",
                "fe80::be24:11ff:fe92:db53"
              ]
            ],
            "keyboard_layout": "en-us",
            "kvm_arguments": null,
            "mac_addresses": [
              "00:00:00:00:00:00",
              "BC:24:11:92:DB:53"
            ],
            "machine": "q35",
            "memory": [
              {
                "dedicated": 16384,
                "floating": 0,
                "hugepages": "",
                "keep_hugepages": false,
                "shared": 0
              }
            ],
            "migrate": false,
            "name": "ai-gpu",
            "network_device": [
              {
                "bridge": "vmbr0",
                "disconnected": false,
                "enabled": true,
                "firewall": false,
                "mac_address": "BC:24:11:92:DB:53",
                "model": "virtio",
                "mtu": 0,
                "queues": 0,
                "rate_limit": 0,
                "trunks": "",
                "vlan_id": 0
              }
            ],
            "network_interface_names": [
              "lo",
              "eth0"
            ],
            "node_name": "server",
            "numa": [],
            "on_boot": true,
            "operating_system": [
              {
                "type": "l26"
              }
            ],
            "pool_id": "",
            "protection": false,
            "purge_on_destroy": true,
            "reboot": false,
            "reboot_after_update": true,
            "rng": [],
            "scsi_hardware": "virtio-scsi-single",
            "serial_device": [],
            "smbios": [],
            "started": true,
            "startup": [
              {
                "down_delay": 60,
                "order": 3,
                "up_delay": 120
              }
            ],
            "stop_on_destroy": false,
            "tablet_device": true,
            "tags": [
              "gpu",
              "ml",
              "ollama",
              "whisper"
            ],
            "template": false,
            "timeout_clone": 1800,
            "timeout_create": 1800,
            "timeout_migrate": 1800,
            "timeout_move_disk": 1800,
            "timeout_reboot": 1800,
            "timeout_shutdown_vm": 1800,
            "timeout_start_vm": 1800,
            "timeout_stop_vm": 300,
            "tpm_state": [],
            "usb": [],
            "vga": [
              {
                "clipboard": "",
                "memory": 16,
                "type": "serial0"
              }
            ],
            "virtiofs": [],
            "vm_id": 115,
            "watchdog": []
          },
          "sensitive_attributes": [
            [
              {
                "type": "get_attr",
                "value": "initialization"
              },
              {
                "type": "index",
                "value": {
                  "value": 0,
                  "type": "number"
                }
              },
              {
                "type": "get_attr",
                "value": "user_account"
              },
              {
                "type": "index",
                "value": {
                  "value": 0,
                  "type": "number"
                }
              },
              {
                "type": "get_attr",
                "value": "password"
              }
            ]
          ],
          "identity_schema_version": 0,
          "private": "bnVsbA==",
          "dependencies": [
            "proxmox_virtual_environment_file.ai_cloud_init"
          ]
        }
      ]
    },
    {
      "mode": "managed",
      "type": "proxmox_virtual_environment_vm",
      "name": "db_postgres",
      "provider": "provider[\"registry.terraform.io/bpg/proxmox\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "acpi": true,
            "agent": [],
            "amd_sev": [],
            "audio_device": [],
            "bios": "ovmf",
            "boot_order": [],
            "cdrom": [],
            "clone": [
              {
                "datastore_id": "",
                "full": true,
                "node_name": "server",
                "retries": 1,
                "vm_id": 9001
              }
            ],
            "cpu": [
              {
                "affinity": "",
                "architecture": "",
                "cores": 4,
                "flags": null,
                "hotplugged": 0,
                "limit": 0,
                "numa": false,
                "sockets": 1,
                "type": "host",
                "units": 0
              }
            ],
            "delete_unreferenced_disks_on_destroy": true,
            "description": "Postgres database host",
            "disk": [
              {
                "aio": "io_uring",
                "backup": true,
                "cache": "none",
                "datastore_id": "local-lvm",
                "discard": "ignore",
                "file_format": "raw",
                "file_id": "",
                "import_from": "",
                "interface": "scsi0",
                "iothread": false,
                "path_in_datastore": "vm-113-disk-1",
                "replicate": true,
                "serial": "",
                "size": 20,
                "speed": [],
                "ssd": false
              },
              {
                "aio": "io_uring",
                "backup": true,
                "cache": "none",
                "datastore_id": "local-lvm",
                "discard": "ignore",
                "file_format": "raw",
                "file_id": "",
                "import_from": "",
                "interface": "scsi1",
                "iothread": false,
                "path_in_datastore": "vm-113-disk-2",
                "replicate": true,
                "serial": "",
                "size": 60,
                "speed": [],
                "ssd": false
              }
            ],
            "efi_disk": [],
            "hook_script_file_id": null,
            "hostpci": [],
            "id": "113",
            "initialization": [
              {
                "datastore_id": "local-lvm",
                "dns": [
                  {
                    "domain": "",
                    "servers": [
                      "1.1.1.1"
                    ]
                  }
                ],
                "file_format": "",
                "interface": "ide2",
                "ip_config": [
                  {
                    "ipv4": [
                      {
                        "address": "192.168.20.21/24",
                        "gateway": "192.168.20.1"
                      }
                    ],
                    "ipv6": []
                  }
                ],
                "meta_data_file_id": "",
                "network_data_file_id": "",
                "type": "",
                "user_account": [
                  {
                    "keys": [
                      "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAhLzivPgJGOMkfj6Fg8WBbPvJIMLQHjpFTnXZVsncBg prakash2ji@gmail.com"
                    ],
                    "password": "**********",
                    "username": "deployer"
                  }
                ],
                "user_data_file_id": "local:snippets/postgres-cloud-init.yaml",
                "vendor_data_file_id": ""
              }
            ],
            "ipv4_addresses": [
              [
                "127.0.0.1"
              ],
              [
                "192.168.20.21"
              ]
            ],
            "ipv6_addresses": [
              [
                "::1"
              ],
              [
                "fdd5:945b:3322::72f",
                "fdd5:945b:3322:0:be24:11ff:fe2f:ae4",
                "fe80::be24:11ff:fe2f:ae4"
              ]
            ],
            "keyboard_layout": "en-us",
            "kvm_arguments": null,
            "mac_addresses": [
              "00:00:00:00:00:00",
              "BC:24:11:2F:0A:E4"
            ],
            "machine": "q35",
            "memory": [
              {
                "dedicated": 8192,
                "floating": 0,
                "hugepages": "",
                "keep_hugepages": false,
                "shared": 0
              }
            ],
            "migrate": false,
            "name": "db-postgres",
            "network_device": [
              {
                "bridge": "vmbr0",
                "disconnected": false,
                "enabled": true,
                "firewall": false,
                "mac_address": "BC:24:11:2F:0A:E4",
                "model": "virtio",
                "mtu": 0,
                "queues": 0,
                "rate_limit": 0,
                "trunks": "",
                "vlan_id": 0
              }
            ],
            "network_interface_names": [
              "lo",
              "eth0"
            ],
            "node_name": "server",
            "numa": [],
            "on_boot": true,
            "operating_system": [
              {
                "type": "l26"
              }
            ],
            "pool_id": "",
            "protection": false,
            "purge_on_destroy": true,
            "reboot": false,
            "reboot_after_update": true,
            "rng": [],
            "scsi_hardware": "virtio-scsi-single",
            "serial_device": [],
            "smbios": [],
            "started": true,
            "startup": [
              {
                "down_delay": 60,
                "order": 1,
                "up_delay": 60
              }
            ],
            "stop_on_destroy": false,
            "tablet_device": true,
            "tags": [
              "db",
              "postgres"
            ],
            "template": false,
            "timeout_clone": 1800,
            "timeout_create": 1800,
            "timeout_migrate": 1800,
            "timeout_move_disk": 1800,
            "timeout_reboot": 1800,
            "timeout_shutdown_vm": 1800,
            "timeout_start_vm": 1800,
            "timeout_stop_vm": 300,
            "tpm_state": [],
            "usb": [],
            "vga": [
              {
                "clipboard": "",
                "memory": 16,
                "type": "serial0"
              }
            ],
            "virtiofs": [],
            "vm_id": 113,
            "watchdog": []
          },
          "sensitive_attributes": [
            [
              {
                "type": "get_attr",
                "value": "initialization"
              },
              {
                "type": "index",
                "value": {
                  "value": 0,
                  "type": "number"
                }
              },
              {
                "type": "get_attr",
                "value": "user_account"
              },
              {
                "type": "index",
                "value": {
                  "value": 0,
                  "type": "number"
                }
              },
              {
                "type": "get_attr",
                "value": "password"
              }
            ]
          ],
          "identity_schema_version": 0,
          "private": "bnVsbA==",
          "dependencies": [
            "proxmox_virtual_environment_file.postgres_cloud_init"
          ]
        }
      ]
    },
    {
      "mode": "managed",
      "type": "proxmox_virtual_environment_vm",
      "name": "infisical",
      "provider": "provider[\"registry.terraform.io/bpg/proxmox\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "acpi": true,
            "agent": [],
            "amd_sev": [],
            "audio_device": [],
            "bios": "ovmf",
            "boot_order": [
              "scsi0"
            ],
            "cdrom": [],
            "clone": [
              {
                "datastore_id": "",
                "full": true,
                "node_name": "server",
                "retries": 1,
                "vm_id": 9001
              }
            ],
            "cpu": [
              {
                "affinity": "",
                "architecture": "",
                "cores": 2,
                "flags": [],
                "hotplugged": 0,
                "limit": 0,
                "numa": false,
                "sockets": 1,
                "type": "host",
                "units": 0
              }
            ],
            "delete_unreferenced_disks_on_destroy": true,
            "description": "Infisical secret management server",
            "disk": [
              {
                "aio": "io_uring",
                "backup": true,
                "cache": "none",
                "datastore_id": "local-lvm",
                "discard": "ignore",
                "file_format": "raw",
                "file_id": "",
                "import_from": "",
                "interface": "scsi0",
                "iothread": false,
                "path_in_datastore": "vm-114-disk-1",
                "replicate": true,
                "serial": "",
                "size": 20,
                "speed": [],
                "ssd": false
              }
            ],
            "efi_disk": [],
            "hook_script_file_id": null,
            "hostpci": [],
            "id": "114",
            "initialization": [
              {
                "datastore_id": "local-lvm",
                "dns": [
                  {
                    "domain": "",
                    "servers": [
                      "1.1.1.1"
                    ]
                  }
                ],
                "file_format": "",
                "interface": "ide2",
                "ip_config": [
                  {
                    "ipv4": [
                      {
                        "address": "192.168.20.22/24",
                        "gateway": "192.168.20.1"
                      }
                    ],
                    "ipv6": []
                  }
                ],
                "meta_data_file_id": "",
                "network_data_file_id": "",
                "type": "",
                "user_account": [
                  {
                    "keys": [
                      "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAhLzivPgJGOMkfj6Fg8WBbPvJIMLQHjpFTnXZVsncBg prakash2ji@gmail.com"
                    ],
                    "password": "**********",
                    "username": "deployer"
                  }
                ],
                "user_data_file_id": "local:snippets/infisical-cloud-init.yaml",
                "vendor_data_file_id": ""
              }
            ],
            "ipv4_addresses": [
              [
                "127.0.0.1"
              ],
              [
                "192.168.20.22"
              ],
              [
                "172.17.0.1"
              ],
              [
                "172.18.0.1"
              ],
              [],
              [],
              []
            ],
            "ipv6_addresses": [
              [
                "::1"
              ],
              [
                "fdd5:945b:3322:0:be24:11ff:fe46:9189",
                "fe80::be24:11ff:fe46:9189"
              ],
              [],
              [
                "fe80::906d:34ff:feaa:5944"
              ],
              [
                "fe80::f0cc:7eff:fe58:6704"
              ],
              [
                "fe80::58f1:9ff:fef4:b91f"
              ],
              [
                "fe80::e4e5:34ff:fe31:131"
              ]
            ],
            "keyboard_layout": "en-us",
            "kvm_arguments": null,
            "mac_addresses": [
              "00:00:00:00:00:00",
              "BC:24:11:46:91:89",
              "6A:5C:BF:1F:3D:73",
              "92:6D:34:AA:59:44",
              "F2:CC:7E:58:67:04",
              "5A:F1:09:F4:B9:1F",
              "E6:E5:34:31:01:31"
            ],
            "machine": "q35",
            "memory": [
              {
                "dedicated": 4096,
                "floating": 0,
                "hugepages": "",
                "keep_hugepages": false,
                "shared": 0
              }
            ],
            "migrate": false,
            "name": "infisical",
            "network_device": [
              {
                "bridge": "vmbr0",
                "disconnected": false,
                "enabled": true,
                "firewall": false,
                "mac_address": "BC:24:11:46:91:89",
                "model": "virtio",
                "mtu": 0,
                "queues": 0,
                "rate_limit": 0,
                "trunks": "",
                "vlan_id": 0
              }
            ],
            "network_interface_names": [
              "lo",
              "eth0",
              "docker0",
              "br-2cb89a95bc6e",
              "veth085ca6c",
              "veth86701f9",
              "vethfe4f51d"
            ],
            "node_name": "server",
            "numa": [],
            "on_boot": true,
            "operating_system": [
              {
                "type": "l26"
              }
            ],
            "pool_id": "",
            "protection": false,
            "purge_on_destroy": true,
            "reboot": false,
            "reboot_after_update": true,
            "rng": [],
            "scsi_hardware": "virtio-scsi-single",
            "serial_device": [],
            "smbios": [],
            "started": true,
            "startup": [
              {
                "down_delay": 60,
                "order": 2,
                "up_delay": 60
              }
            ],
            "stop_on_destroy": false,
            "tablet_device": true,
            "tags": [
              "infisical",
              "secrets"
            ],
            "template": false,
            "timeout_clone": 1800,
            "timeout_create": 1800,
            "timeout_migrate": 1800,
            "timeout_move_disk": 1800,
            "timeout_reboot": 1800,
            "timeout_shutdown_vm": 1800,
            "timeout_start_vm": 1800,
            "timeout_stop_vm": 300,
            "tpm_state": [],
            "usb": [],
            "vga": [],
            "virtiofs": [],
            "vm_id": 114,
            "watchdog": []
          },
          "sensitive_attributes": [
            [
              {
                "type": "get_attr",
                "value": "initialization"
              },
              {
                "type": "index",
                "value": {
                  "value": 0,
                  "type": "number"
                }
              },
              {
                "type": "get_attr",
                "value": "user_account"
              },
              {
                "type": "index",
                "value": {
                  "value": 0,
                  "type": "number"
                }
              },
              {
                "type": "get_attr",
                "value": "password"
              }
            ]
          ],
          "identity_schema_version": 0,
          "private": "bnVsbA==",
          "dependencies": [
            "proxmox_virtual_environment_file.infisical_cloud_init",
            "proxmox_virtual_environment_file.postgres_cloud_init",
            "proxmox_virtual_environment_vm.db_postgres"
          ]
        }
      ]
    },
    {
      "mode": "managed",
      "type": "proxmox_virtual_environment_vm",
      "name": "k3s_apps",
      "provider": "provider[\"registry.terraform.io/bpg/proxmox\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "acpi": true,
            "agent": [],
            "amd_sev": [],
            "audio_device": [],
            "bios": "ovmf",
            "boot_order": [
              "scsi0"
            ],
            "cdrom": [],
            "clone": [
              {
                "datastore_id": "",
                "full": true,
                "node_name": "server",
                "retries": 1,
                "vm_id": 9001
              }
            ],
            "cpu": [
              {
                "affinity": "",
                "architecture": "",
                "cores": 8,
                "flags": [],
                "hotplugged": 0,
                "limit": 0,
                "numa": false,
                "sockets": 1,
                "type": "host",
                "units": 0
              }
            ],
            "delete_unreferenced_disks_on_destroy": true,
            "description": "K3s single-node cluster host",
            "disk": [
              {
                "aio": "io_uring",
                "backup": true,
                "cache": "none",
                "datastore_id": "local-lvm",
                "discard": "ignore",
                "file_format": "raw",
                "file_id": "",
                "import_from": "",
                "interface": "scsi0",
                "iothread": false,
                "path_in_datastore": "vm-112-disk-1",
                "replicate": true,
                "serial": "",
                "size": 80,
                "speed": [],
                "ssd": false
              }
            ],
            "efi_disk": [],
            "hook_script_file_id": null,
            "hostpci": [],
            "id": "112",
            "initialization": [
              {
                "datastore_id": "local-lvm",
                "dns": [
                  {
                    "domain": "",
                    "servers": [
                      "1.1.1.1"
                    ]
                  }
                ],
                "file_format": "",
                "interface": "ide2",
                "ip_config": [
                  {
                    "ipv4": [
                      {
                        "address": "192.168.20.11/24",
                        "gateway": "192.168.20.1"
                      }
                    ],
                    "ipv6": []
                  }
                ],
                "meta_data_file_id": "",
                "network_data_file_id": "",
                "type": "",
                "user_account": [
                  {
                    "keys": [
                      "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAhLzivPgJGOMkfj6Fg8WBbPvJIMLQHjpFTnXZVsncBg prakash2ji@gmail.com"
                    ],
                    "password": "**********",
                    "username": "deployer"
                  }
                ],
                "user_data_file_id": "",
                "vendor_data_file_id": ""
              }
            ],
            "ipv4_addresses": [
              [
                "127.0.0.1"
              ],
              [
                "192.168.20.11"
              ],
              [
                "10.42.0.0"
              ],
              [
                "10.42.0.1"
              ],
              [],
              [],
              [],
              [],
              [],
              [],
              [],
              [],
              [],
              [],
              [],
              [],
              [],
              [],
              [],
              [],
              [],
              [],
              [],
              [],
              [],
              [],
              [],
              [],
              [],
              []
            ],
            "ipv6_addresses": [
              [
                "::1"
              ],
              [
                "fdd5:945b:3322::a69",
                "fdd5:945b:3322:0:be24:11ff:fea4:aa84",
                "fe80::be24:11ff:fea4:aa84"
              ],
              [
                "fe80::c85d:feff:fe8e:5808"
              ],
              [
                "fe80::14b5:89ff:fe2c:2ed3"
              ],
              [
                "fe80::248e:16ff:fed3:405f"
              ],
              [
                "fe80::2040:f3ff:fe91:8485"
              ],
              [
                "fe80::705a:39ff:fe9a:25a4"
              ],
              [
                "fe80::cc0a:c8ff:fe2c:f729"
              ],
              [
                "fe80::ec37:7aff:fe72:f123"
              ],
              [
                "fe80::800:8cff:fe91:686c"
              ],
              [
                "fe80::ecb5:21ff:fe1d:4638"
              ],
              [
                "fe80::480c:fcff:fe03:5c72"
              ],
              [
                "fe80::8cff:3dff:fed1:2b05"
              ],
              [
                "fe80::749c:b6ff:fe17:6101"
              ],
              [
                "fe80::78e6:88ff:fef5:4a8d"
              ],
              [
                "fe80::4424:d7ff:feb2:52dd"
              ],
              [
                "fe80::1079:12ff:fef0:7517"
              ],
              [
                "fe80::584f:87ff:fe39:b601"
              ],
              [
                "fe80::946c:6aff:fe0e:28be"
              ],
              [
                "fe80::801a:c3ff:feff:255"
              ],
              [
                "fe80::4c67:e8ff:fe40:8f0a"
              ],
              [
                "fe80::c8a7:e9ff:fe04:cce8"
              ],
              [
                "fe80::cc2d:4bff:fe21:a40e"
              ],
              [
                "fe80::2021:bfff:fe7e:df64"
              ],
              [
                "fe80::5c1a:4bff:fed1:9267"
              ],
              [
                "fe80::d463:bcff:fefc:4c0"
              ],
              [
                "fe80::d44a:12ff:fe07:4460"
              ],
              [
                "fe80::cf:7ff:fe4a:5c8e"
              ],
              [
                "fe80::f87d:7cff:fed5:1685"
              ],
              [
                "fe80::fcc3:65ff:fe92:6fe9"
              ]
            ],
            "keyboard_layout": "en-us",
            "kvm_arguments": null,
            "mac_addresses": [
              "00:00:00:00:00:00",
              "BC:24:11:A4:AA:84",
              "CA:5D:FE:8E:58:08",
              "16:B5:89:2C:2E:D3",
              "26:8E:16:D3:40:5F",
              "22:40:F3:91:84:85",
              "72:5A:39:9A:25:A4",
              "CE:0A:C8:2C:F7:29",
              "EE:37:7A:72:F1:23",
              "0A:00:8C:91:68:6C",
              "EE:B5:21:1D:46:38",
              "4A:0C:FC:03:5C:72",
              "8E:FF:3D:D1:2B:05",
              "76:9C:B6:17:61:01",
              "7A:E6:88:F5:4A:8D",
              "46:24:D7:B2:52:DD",
              "12:79:12:F0:75:17",
              "5A:4F:87:39:B6:01",
              "96:6C:6A:0E:28:BE",
              "82:1A:C3:FF:02:55",
              "4E:67:E8:40:8F:0A",
              "CA:A7:E9:04:CC:E8",
              "CE:2D:4B:21:A4:0E",
              "22:21:BF:7E:DF:64",
              "5E:1A:4B:D1:92:67",
              "D6:63:BC:FC:04:C0",
              "D6:4A:12:07:44:60",
              "02:CF:07:4A:5C:8E",
              "FA:7D:7C:D5:16:85",
              "FE:C3:65:92:6F:E9"
            ],
            "machine": "q35",
            "memory": [
              {
                "dedicated": 12288,
                "floating": 0,
                "hugepages": "",
                "keep_hugepages": false,
                "shared": 0
              }
            ],
            "migrate": false,
            "name": "k3s-apps",
            "network_device": [
              {
                "bridge": "vmbr0",
                "disconnected": false,
                "enabled": true,
                "firewall": false,
                "mac_address": "BC:24:11:A4:AA:84",
                "model": "virtio",
                "mtu": 0,
                "queues": 0,
                "rate_limit": 0,
                "trunks": "",
                "vlan_id": 0
              }
            ],
            "network_interface_names": [
              "lo",
              "eth0",
              "flannel.1",
              "cni0",
              "vethecc432e3",
              "vethea2f11bc",
              "veth01f59774",
              "veth9ada66c7",
              "vethabbdb5dc",
              "veth4005f5bc",
              "vethb96c591f",
              "veth570748ed",
              "vethbc8c1b09",
              "vethf8b852a4",
              "vetha30cc56a",
              "veth8fe38d2e",
              "veth160859f8",
              "veth1f0783e6",
              "veth9043481d",
              "vethdc04e92f",
              "veth586cf89c",
              "veth8519f0a0",
              "veth70a63f6c",
              "vethbc06a8e8",
              "veth9184e42d",
              "vethdb0cf0cd",
              "veth942f907b",
              "veth1c20e7d2",
              "veth66462def",
              "veth14879e26"
            ],
            "node_name": "server",
            "numa": [],
            "on_boot": true,
            "operating_system": [
              {
                "type": "l26"
              }
            ],
            "pool_id": "",
            "protection": false,
            "purge_on_destroy": true,
            "reboot": false,
            "reboot_after_update": true,
            "rng": [],
            "scsi_hardware": "virtio-scsi-single",
            "serial_device": [],
            "smbios": [],
            "started": true,
            "startup": [
              {
                "down_delay": 60,
                "order": 1,
                "up_delay": 60
              }
            ],
            "stop_on_destroy": false,
            "tablet_device": true,
            "tags": [
              "apps",
              "k3s"
            ],
            "template": false,
            "timeout_clone": 1800,
            "timeout_create": 1800,
            "timeout_migrate": 1800,
            "timeout_move_disk": 1800,
            "timeout_reboot": 1800,
            "timeout_shutdown_vm": 1800,
            "timeout_start_vm": 1800,
            "timeout_stop_vm": 300,
            "tpm_state": [],
            "usb": [],
            "vga": [],
            "virtiofs": [],
            "vm_id": 112,
            "watchdog": []
          },
          "sensitive_attributes": [
            [
              {
                "type": "get_attr",
                "value": "initialization"
              },
              {
                "type": "index",
                "value": {
                  "value": 0,
                  "type": "number"
                }
              },
              {
                "type": "get_attr",
                "value": "user_account"
              },
              {
                "type": "index",
                "value": {
                  "value": 0,
                  "type": "number"
                }
              },
              {
                "type": "get_attr",
                "value": "password"
              }
            ]
          ],
          "identity_schema_version": 0,
          "private": "bnVsbA=="
        }
      ]
    },
    {
      "mode": "managed",
      "type": "proxmox_virtual_environment_vm",
      "name": "whisper_gpu",
      "provider": "provider[\"registry.terraform.io/bpg/proxmox\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "acpi": true,
            "agent": [],
            "amd_sev": [],
            "audio_device": [],
            "bios": "ovmf",
            "boot_order": [],
            "cdrom": [],
            "clone": [
              {
                "datastore_id": "",
                "full": true,
                "node_name": "server",
                "retries": 1,
                "vm_id": 9003
              }
            ],
            "cpu": [
              {
                "affinity": "",
                "architecture": "",
                "cores": 4,
                "flags": null,
                "hotplugged": 0,
                "limit": 0,
                "numa": false,
                "sockets": 1,
                "type": "host",
                "units": 0
              }
            ],
            "delete_unreferenced_disks_on_destroy": true,
            "description": "Whisper AI inference server with GPU passthrough",
            "disk": [
              {
                "aio": "io_uring",
                "backup": true,
                "cache": "none",
                "datastore_id": "local-lvm",
                "discard": "ignore",
                "file_format": "raw",
                "file_id": "",
                "import_from": "",
                "interface": "scsi0",
                "iothread": false,
                "path_in_datastore": "vm-115-disk-1",
                "replicate": true,
                "serial": "",
                "size": 50,
                "speed": [],
                "ssd": false
              }
            ],
            "efi_disk": [
              {
                "datastore_id": "local-lvm",
                "file_format": "raw",
                "pre_enrolled_keys": false,
                "type": "4m"
              }
            ],
            "hook_script_file_id": null,
            "hostpci": [
              {
                "device": "hostpci0",
                "id": "",
                "mapping": "gpu-quadro-m4000",
                "mdev": "",
                "pcie": true,
                "rom_file": "",
                "rombar": true,
                "xvga": false
              }
            ],
            "id": "115",
            "initialization": [
              {
                "datastore_id": "local-lvm",
                "dns": [
                  {
                    "domain": "",
                    "servers": [
                      "1.1.1.1"
                    ]
                  }
                ],
                "file_format": "",
                "interface": "ide2",
                "ip_config": [
                  {
                    "ipv4": [
                      {
                        "address": "192.168.20.30/24",
                        "gateway": "192.168.20.1"
                      }
                    ],
                    "ipv6": []
                  }
                ],
                "meta_data_file_id": "",
                "network_data_file_id": "",
                "type": "",
                "user_account": [
                  {
                    "keys": [
                      "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAhLzivPgJGOMkfj6Fg8WBbPvJIMLQHjpFTnXZVsncBg prakash2ji@gmail.com"
                    ],
                    "password": "**********",
                    "username": "deployer"
                  }
                ],
                "user_data_file_id": "local:snippets/whisper-cloud-init.yaml",
                "vendor_data_file_id": ""
              }
            ],
            "ipv4_addresses": [
              [
                "127.0.0.1"
              ],
              [
                "192.168.20.30"
              ]
            ],
            "ipv6_addresses": [
              [
                "::1"
              ],
              [
                "fdd5:945b:3322::43b",
                "fdd5:945b:3322:0:be24:11ff:feaf:d1e1",
                "fe80::be24:11ff:feaf:d1e1"
              ]
            ],
            "keyboard_layout": "en-us",
            "kvm_arguments": null,
            "mac_addresses": [
              "00:00:00:00:00:00",
              "BC:24:11:AF:D1:E1"
            ],
            "machine": "q35",
            "memory": [
              {
                "dedicated": 16384,
                "floating": 0,
                "hugepages": "",
                "keep_hugepages": false,
                "shared": 0
              }
            ],
            "migrate": false,
            "name": "whisper-gpu",
            "network_device": [
              {
                "bridge": "vmbr0",
                "disconnected": false,
                "enabled": true,
                "firewall": false,
                "mac_address": "BC:24:11:AF:D1:E1",
                "model": "virtio",
                "mtu": 0,
                "queues": 0,
                "rate_limit": 0,
                "trunks": "",
                "vlan_id": 0
              }
            ],
            "network_interface_names": [
              "lo",
              "eth0"
            ],
            "node_name": "server",
            "numa": [],
            "on_boot": true,
            "operating_system": [
              {
                "type": "l26"
              }
            ],
            "pool_id": "",
            "protection": false,
            "purge_on_destroy": true,
            "reboot": false,
            "reboot_after_update": true,
            "rng": [],
            "scsi_hardware": "virtio-scsi-single",
            "serial_device": [],
            "smbios": [],
            "started": true,
            "startup": [
              {
                "down_delay": 60,
                "order": 3,
                "up_delay": 120
              }
            ],
            "stop_on_destroy": false,
            "tablet_device": true,
            "tags": [
              "gpu",
              "ml",
              "whisper"
            ],
            "template": false,
            "timeout_clone": 1800,
            "timeout_create": 1800,
            "timeout_migrate": 1800,
            "timeout_move_disk": 1800,
            "timeout_reboot": 1800,
            "timeout_shutdown_vm": 1800,
            "timeout_start_vm": 1800,
            "timeout_stop_vm": 300,
            "tpm_state": [],
            "usb": [],
            "vga": [
              {
                "clipboard": "",
                "memory": 16,
                "type": "serial0"
              }
            ],
            "virtiofs": [],
            "vm_id": 115,
            "watchdog": []
          },
          "sensitive_attributes": [
            [
              {
                "type": "get_attr",
                "value": "initialization"
              },
              {
                "type": "index",
                "value": {
                  "value": 0,
                  "type": "number"
                }
              },
              {
                "type": "get_attr",
                "value": "user_account"
              },
              {
                "type": "index",
                "value": {
                  "value": 0,
                  "type": "number"
                }
              },
              {
                "type": "get_attr",
                "value": "password"
              }
            ]
          ],
          "identity_schema_version": 0,
          "private": "bnVsbA==",
          "dependencies": [
            "proxmox_virtual_environment_file.whisper_cloud_init"
          ]
        }
      ]
    }
  ],
  "check_results": null
}
